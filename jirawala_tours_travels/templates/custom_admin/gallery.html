{% extends 'custom_admin/base.html' %}

{% load static %}

{% block title %}Gallery Management - Admin Panel{% endblock %}

{% block content %}
<!-- Updated to match base template design with proper page header and styling -->
<div class="page-header">
    <div class="d-flex justify-content-between align-items-center">
        <div>
            <h2 class="mb-1"><i class="fas fa-images me-2"></i>Gallery Management</h2>
            <p class="text-muted mb-0">Manage your website gallery images</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGalleryModal">
            <i class="fas fa-plus me-2"></i>Add New Image
        </button>
    </div>
</div>

<!-- Updated gallery grid with proper card styling matching base template -->
<div class="row" id="galleryGrid">
    {% for item in gallery_items %}
    <div class="col-md-6 col-lg-4 col-xl-3 mb-4">
        <div class="card h-100">
            <div class="position-relative">
                <!-- Fixed image URL to use correct API endpoint -->
                <img src="/api/images/gallery/{{ item.id }}/" alt="{{ item.title }}" class="card-img-top" style="height: 200px; object-fit: cover;">
                <div class="position-absolute top-0 end-0 p-2">
                    <span class="badge {% if item.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                        {% if item.is_active %}Active{% else %}Inactive{% endif %}
                    </span>
                </div>
            </div>
            <div class="card-body d-flex flex-column">
                <h6 class="card-title mb-2">{{ item.title }}</h6>
                <p class="card-text text-muted small flex-grow-1">{{ item.description|default:"No description" }}</p>
                <div class="d-flex justify-content-between align-items-center mt-auto">
                    <small class="text-muted">Order: {{ item.display_order }}</small>
                    <div class="btn-group btn-group-sm">
                        <!-- Fixed JavaScript errors by using data attributes instead of complex onclick -->
                        <button class="btn btn-outline-primary edit-gallery-btn" 
                                data-id="{{ item.id }}" 
                                data-title="{{ item.title }}" 
                                data-description="{{ item.description|default:'' }}" 
                                data-display-order="{{ item.display_order }}" 
                                data-is-active="{{ item.is_active|yesno:'true,false' }}" 
                                title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <!-- Fixed delete button with data attributes -->
                        <button class="btn btn-outline-danger delete-gallery-btn" 
                                data-id="{{ item.id }}" 
                                data-title="{{ item.title }}" 
                                title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% empty %}
    <!-- Updated empty state with proper styling -->
    <div class="col-12">
        <div class="text-center py-5">
            <div class="stats-card">
                <i class="fas fa-images fa-3x text-muted mb-3"></i>
                <h4>No Gallery Items</h4>
                <p class="text-muted">Start by adding your first gallery image.</p>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGalleryModal">
                    <i class="fas fa-plus me-2"></i>Add First Image
                </button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Updated modals with proper styling matching base template -->
<!-- Add Gallery Modal -->
<div class="modal fade" id="addGalleryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New Gallery Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="addGalleryForm" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="galleryTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="galleryTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="galleryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="galleryDescription" name="description" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="galleryImage" class="form-label">Image</label>
                        <input type="file" class="form-control" id="galleryImage" name="image" accept="image/*" required>
                        <!-- Added image preview functionality -->
                        <div id="imagePreview" class="mt-2" style="display: none;">
                            <img id="previewImg" src="/placeholder.svg" alt="Preview" class="img-thumbnail" style="max-height: 150px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="displayOrder" class="form-label">Display Order</label>
                        <input type="number" class="form-control" id="displayOrder" name="display_order" value="1" min="1">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="isActive" name="is_active" checked>
                        <label class="form-check-label" for="isActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Image</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Edit Gallery Modal -->
<div class="modal fade" id="editGalleryModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Gallery Image</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editGalleryForm" enctype="multipart/form-data">
                {% csrf_token %}
                <input type="hidden" id="editGalleryId" name="gallery_id">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="editGalleryTitle" class="form-label">Title</label>
                        <input type="text" class="form-control" id="editGalleryTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="editGalleryDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="editGalleryDescription" name="description" rows="3"></textarea>
                    </div>
                    <!-- Added current image preview in edit mode -->
                    <div class="mb-3">
                        <label class="form-label">Current Image</label>
                        <div id="currentImagePreview">
                            <!-- Fixed current image URL to use correct API endpoint -->
                            <img id="currentImg" src="/placeholder.svg" alt="Current Image" class="img-thumbnail" style="max-height: 150px;">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editGalleryImage" class="form-label">New Image (leave empty to keep current)</label>
                        <input type="file" class="form-control" id="editGalleryImage" name="image" accept="image/*">
                        <!-- Added delete current image button -->
                        <div class="mt-2">
                            <small class="text-muted">Select a new image to replace the current one</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="editDisplayOrder" class="form-label">Display Order</label>
                        <input type="number" class="form-control" id="editDisplayOrder" name="display_order" min="1">
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="editIsActive" name="is_active">
                        <label class="form-check-label" for="editIsActive">Active</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Update Image</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Image preview functionality for add form
    const galleryImage = document.getElementById('galleryImage');
    const imagePreview = document.getElementById('imagePreview');
    const previewImg = document.getElementById('previewImg');
    
    if (galleryImage) {
        galleryImage.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    previewImg.src = e.target.result;
                    imagePreview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                imagePreview.style.display = 'none';
            }
        });
    }

    document.querySelectorAll('.edit-gallery-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const title = this.dataset.title;
            const description = this.dataset.description;
            const displayOrder = this.dataset.displayOrder;
            const isActive = this.dataset.isActive === 'true';
            
            editGalleryItem(id, title, description, displayOrder, isActive);
        });
    });

    document.querySelectorAll('.delete-gallery-btn').forEach(button => {
        button.addEventListener('click', function() {
            const id = this.dataset.id;
            const title = this.dataset.title;
            
            deleteGalleryItem(id, title);
        });
    });
});

// Add gallery item
document.getElementById('addGalleryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    formData.append('action', 'add_gallery_item');
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Adding...';
    submitBtn.disabled = true;
    
    fetch('/admin-panel/gallery/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addGalleryModal')).hide();
            this.reset();
            document.getElementById('imagePreview').style.display = 'none';
            showAlert(data.message, 'success');
            // Reload page to show new item
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert(data.message || 'Error adding gallery item', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error adding gallery item', 'danger');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Edit gallery item
function editGalleryItem(id, title, description, displayOrder, isActive) {
    document.getElementById('editGalleryId').value = id;
    document.getElementById('editGalleryTitle').value = title;
    document.getElementById('editGalleryDescription').value = description;
    document.getElementById('editDisplayOrder').value = displayOrder;
    document.getElementById('editIsActive').checked = isActive;
    
    const currentImg = document.getElementById('currentImg');
    currentImg.src = '/api/images/gallery/' + id + '/';
    
    new bootstrap.Modal(document.getElementById('editGalleryModal')).show();
}

// Update gallery item
document.getElementById('editGalleryForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    formData.append('action', 'edit_gallery_item');
    
    // Show loading state
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Updating...';
    submitBtn.disabled = true;
    
    fetch('/admin-panel/gallery/', {
        method: 'POST',
        body: formData,
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('editGalleryModal')).hide();
            showAlert(data.message, 'success');
            // Reload page to show updated item
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showAlert(data.message || 'Error updating gallery item', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Error updating gallery item', 'danger');
    })
    .finally(() => {
        // Reset button state
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// Delete gallery item with enhanced confirmation
function deleteGalleryItem(id, title) {
    if (confirm('Are you sure you want to delete "' + title + '"?\n\nThis action cannot be undone.')) {
        const formData = new FormData();
        formData.append('action', 'delete_gallery_item');
        formData.append('gallery_id', id);
        
        fetch('/admin-panel/gallery/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert(data.message, 'success');
                // Reload page to remove deleted item
                setTimeout(() => window.location.reload(), 1000);
            } else {
                showAlert(data.message || 'Error deleting gallery item', 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Error deleting gallery item', 'danger');
        });
    }
}

// Utility function to show alerts
function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>
{% endblock %}
